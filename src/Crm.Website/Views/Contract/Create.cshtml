@using Crm.Website;
@using Crm.Website.Models;
@using Crm.Api;
@{
    ViewBag.Title = "创建合同";
    Layout = "~/Views/Contract/Layout.cshtml";
    this.ViewBag.LeftMenu = "Create";
}

<p class="lead">创建合同</p>
<form class="form-horizontal" id="createContractForm">
    <div id="contractBaseInfo">
        <div class="control-group">
            <label class="control-label" >名称<font style="color: Red">*</font></label>
            <div class="controls">
                <input type="text" name="name" class="input-xlarge" data-required="true"/>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >客户<font style="color: Red">*</font></label>
            <div class="controls">
                <input id="txtCustomerName" type="text" readonly="readonly" class="input-xlarge" name="customerName"/>
                <input id="txtCustomerId" type="hidden" name="customerId"/>
                <button id="btnSelectCustomer" class="btn">选择</button>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >拥有者<font style="color: Red">*</font></label>
                
            <div class="controls">
                @this.Html.Raw(WebHelper.UsersCheckboxList("owners", true, true))
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >开始日期<font style="color: Red">*</font></label>
            <div class="controls">
                <input type="text" class="input-xlarge date" data-required="true" name="startDate"/>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >结束日期<font style="color: Red">*</font></label>
            <div class="controls">
                <input type="text" class="input-xlarge date" data-required="true" name="endDate"/>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >合同金额<font style="color: Red">*</font></label>
            <div class="controls">
                <input type="text" class="input-xlarge" data-required="true" data-pattern="^\d+(\.\d+)?$" name="value"/>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" >到期计算天数<font style="color: Red">*</font></label>
            <div class="controls">
                <input type="text" class="input-xlarge" data-required="true" value="30" data-pattern="^\+?[1-9][0-9]*$" name="expiredComputeDays"/>
            </div>
        </div>
    </div>
    <div id="contractExtendInfo">
        @{this.Html.RenderAction("Fields", "Extend", new { formType = FormType.Contract });}
    </div>
    <div class="control-group">
    <div class="controls">
        <button id="btnCreate" type="submit" class="btn btn-primary" data-loading-text="保存中...">创建</button>
        <button id="btnCancel" type="button" class="btn">取消</button>
    </div>
    </div>
</form>
<div id="customerSelectDialog" >
    @{this.Html.RenderAction("SelectDialog", "Customer");}
</div>
<script language="javascript" type="text/javascript">
$("#createContractForm").validate({
    sendForm : false,
    onBlur: true,
    onChange: true,
	eachValidField : function() {
		$(this).closest('.control-group').removeClass('error');
        $(this).next('.help-inline').hide();
	},
	eachInvalidField : function() {
		$(this).closest('.control-group').addClass('error');
        $(this).next('.help-inline').show();
	},
    valid: function(){
        var formValue = $("#contractBaseInfo").getFormValue();
        formValue.extends = $("#contractExtendInfo").getFormValue();
            
        $("#btnCreate").button("loading");
        $.post("@this.Url.Action("Create")", {json: $.toJSON(formValue)}, function(data){
            $("#btnCreate").button("reset");
            if(data.result == 0){
                location = "@this.Url.Action("Index")";
            }
            else{
                alert(data.message);
            }
        });
    }
});
$("#btnCancel").click(function(){
    location = "@this.Url.Action("Index")";
});

var customerSelectDialog = $("#customerSelectDialog").customerSelectDialog({baseUrl: "@this.Url.Content("~/")"});

$("#btnSelectCustomer").click(function(){
    customerSelectDialog.customerSelectDialog("select", function(args){
        $("#txtCustomerId").val(args.id);
        $("#txtCustomerName").val(args.name);
    });
    return false;
});

$(".date").datepicker();
</script>